# Agent-agnostic alias for agents-72-codex-belt-worker.
# Keeps the old filename working while new callers use this name.
name: Agents Belt Worker

on:
  workflow_call:
    inputs:
      agent_key:
        description: 'Agent key for this belt run'
        required: false
        default: 'codex'
        type: string
      issue:
        description: 'Issue number'
        required: true
        type: string
      branch:
        description: 'Branch to prepare'
        required: true
        type: string
      base:
        description: 'Base branch'
        required: false
        default: ''
        type: string
      source:
        description: 'Source of invocation'
        required: false
        default: 'orchestrator'
        type: string
      dry_run:
        description: 'Preview actions without writes'
        required: false
        default: false
        type: boolean
      use_step_branch:
        description: 'Allow fallback step branch'
        required: false
        default: false
        type: boolean
      max_parallel:
        description: 'Max concurrent runs'
        required: false
        default: 1
        type: number
      keepalive:
        description: 'Keepalive sweep origin'
        required: false
        default: false
        type: boolean
    secrets:
      ACTIONS_BOT_PAT:
        required: false
      SERVICE_BOT_PAT:
        required: false
      OWNER_PR_PAT:
        required: false
      OPENAI_API_KEY:
        required: false
      CODEX_AUTH_JSON:
        required: false
      CLAUDE_AUTH_JSON:
        required: false
      WORKFLOWS_APP_ID:
        required: false
      WORKFLOWS_APP_PRIVATE_KEY:
        required: false
      KEEPALIVE_APP_ID:
        required: false
      KEEPALIVE_APP_PRIVATE_KEY:
        required: false
    outputs:
      allowed:
        description: 'Whether the worker was allowed to proceed'
        value: ${{ jobs.delegate.outputs.allowed }}
      pr_number:
        description: 'PR number created or updated'
        value: ${{ jobs.delegate.outputs.pr_number }}
      branch:
        description: 'Branch name used'
        value: ${{ jobs.delegate.outputs.branch }}
      dry_run:
        description: 'Whether this was a dry run'
        value: ${{ jobs.delegate.outputs.dry_run }}
      keepalive_action:
        description: 'Keepalive action taken'
        value: ${{ jobs.delegate.outputs.keepalive_action }}
      keepalive_reason:
        description: 'Keepalive reason'
        value: ${{ jobs.delegate.outputs.keepalive_reason }}
      keepalive_head_sha:
        description: 'Keepalive head SHA'
        value: ${{ jobs.delegate.outputs.keepalive_head_sha }}
      keepalive_last_instruction_id:
        description: 'Last processed keepalive instruction ID'
        value: ${{ jobs.delegate.outputs.keepalive_last_instruction_id }}
      keepalive_last_instruction_head_sha:
        description: 'Last processed keepalive instruction head SHA'
        value: ${{ jobs.delegate.outputs.keepalive_last_instruction_head_sha }}

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write

jobs:
  delegate:
    uses: ./.github/workflows/agents-72-codex-belt-worker.yml
    with:
      agent_key: ${{ inputs.agent_key }}
      issue: ${{ inputs.issue }}
      branch: ${{ inputs.branch }}
      base: ${{ inputs.base }}
      source: ${{ inputs.source }}
      dry_run: ${{ inputs.dry_run }}
      use_step_branch: ${{ inputs.use_step_branch }}
      max_parallel: ${{ inputs.max_parallel }}
      keepalive: ${{ inputs.keepalive }}
    secrets: inherit
