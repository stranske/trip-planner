# See docs/ci/AGENTS_POLICY.md for guardrails and override process.
name: Agents Auto-Pilot

# End-to-end automation: Issue ‚Üí Optimize ‚Üí Agent ‚Üí Keepalive ‚Üí Merge
# Triggered by agents:auto-pilot label, orchestrates the full pipeline

on:
  issues:
    types: [labeled, closed]
  pull_request:
    types: [labeled, closed]
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Issue number to auto-pilot"
        required: true
        type: number
      force_step:
        description: "Force a specific step (optional, leave as 'auto' for normal flow)"
        required: false
        type: choice
        options:
          - auto
          - format
          - optimize
          - apply
          - capability-check
          - agent
          - verify

permissions:
  contents: read
  issues: write
  pull-requests: write  # Needed to create PRs automatically

env:
  # Safety limits
  MAX_CYCLES: 10
  MAX_WALL_TIME_HOURS: 4

jobs:
  auto-pilot:
    runs-on: ubuntu-latest
    timeout-minutes: 240  # 4 hours = MAX_WALL_TIME_HOURS
    # Trigger on agents:auto-pilot label or workflow_dispatch
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event.action == 'labeled' &&
       github.event.label.name == 'agents:auto-pilot') ||
      (github.event.action == 'closed' &&
       contains(github.event.issue.labels.*.name, 'agents:auto-pilot'))

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine context
        id: context
        uses: actions/github-script@v7
        with:
          script: |
            let issueNumber, issue, pr;

            // Get issue number from various sources
            if (context.eventName === 'workflow_dispatch') {
              issueNumber = parseInt('${{ inputs.issue_number }}');
            } else if (context.payload.issue) {
              issueNumber = context.payload.issue.number;
              issue = context.payload.issue;
            } else if (context.payload.pull_request) {
              // For PR events, find linked issue
              pr = context.payload.pull_request;
              const bodyMatch = pr.body?.match(/#(\d+)/);
              issueNumber = bodyMatch ? parseInt(bodyMatch[1]) : null;
            }

            if (!issueNumber) {
              core.setFailed('Could not determine issue number');
              return;
            }

            // Fetch issue if not in payload
            if (!issue) {
              const { data } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber
              });
              issue = data;
            }

            const labels = issue.labels.map(l => l.name);

            // Check for pause label
            if (labels.includes('agents:auto-pilot-pause')) {
              core.info('Auto-pilot paused by agents:auto-pilot-pause label');
              core.setOutput('should_continue', 'false');
              core.setOutput('reason', 'paused');
              return;
            }

            // Check for failure/needs-human
            if (labels.includes('needs-human') || labels.includes('agents:auto-pilot-failed')) {
              core.info('Auto-pilot stopped: requires human intervention');
              core.setOutput('should_continue', 'false');
              core.setOutput('reason', 'needs-human');
              return;
            }

            // Determine current state
            const hasFormat = labels.includes('agents:format');
            const hasOptimize = labels.includes('agents:optimize');
            const hasApplySuggestions = labels.includes('agents:apply-suggestions');
            const hasAgentCodex = labels.includes('agent:codex');
            const hasAutofix = labels.includes('autofix');
            const hasAutomerge = labels.includes('automerge');
            const hasVerify = labels.includes('verify:evaluate');

            // Check for linked PR (with pagination and multiple event types)
            const timelineEvents = await github.paginate(
              github.rest.issues.listEventsForTimeline,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                per_page: 100
              }
            );

            let linkedPR = null;
            for (const event of timelineEvents) {
              // Handle both cross-referenced and connected events
              if ((event.event === 'cross-referenced' || event.event === 'connected') &&
                  event.source?.issue?.pull_request) {
                linkedPR = event.source.issue.number;
              }
            }

            core.setOutput('issue_number', issueNumber);
            core.setOutput('issue_title', issue.title);
            core.setOutput('issue_state', issue.state);
            core.setOutput('should_continue', 'true');
            core.setOutput('has_format', hasFormat.toString());
            core.setOutput('has_optimize', hasOptimize.toString());
            core.setOutput('has_apply', hasApplySuggestions.toString());
            core.setOutput('has_agent', hasAgentCodex.toString());
            core.setOutput('has_autofix', hasAutofix.toString());
            core.setOutput('has_automerge', hasAutomerge.toString());
            core.setOutput('has_verify', hasVerify.toString());
            core.setOutput('linked_pr', linkedPR || '');

            console.log(`Issue #${issueNumber} state:`);
            console.log(`  State: ${issue.state}`);
            console.log(`  Labels: ${labels.join(', ')}`);
            console.log(`  Linked PR: ${linkedPR || 'none'}`);

      - name: Check step count
        if: steps.context.outputs.should_continue == 'true'
        id: cycles
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ steps.context.outputs.issue_number }}
        with:
          script: |
            const issueNumber = parseInt(process.env.ISSUE_NUMBER);

            // Get all comments to count auto-pilot steps (with pagination)
            const allComments = await github.paginate(
              github.rest.issues.listComments,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                per_page: 100
              }
            );

            const stepComments = allComments.filter(c =>
              typeof c.body === 'string' && c.body.includes('ü§ñ Auto-pilot step')
            );

            const stepCount = stepComments.length;
            const maxCycles = parseInt('${{ env.MAX_CYCLES }}');

            if (stepCount >= maxCycles) {
              core.warning(`Auto-pilot exceeded max steps (${stepCount}/${maxCycles})`);
              core.setOutput('exceeded', 'true');
              return;
            }

            core.setOutput('exceeded', 'false');
            core.setOutput('count', stepCount.toString());

      - name: Stop if exceeded
        if: steps.cycles.outputs.exceeded == 'true'
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ steps.context.outputs.issue_number }}
        with:
          script: |
            const issueNumber = parseInt(process.env.ISSUE_NUMBER);

            // Add failure label and comment
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['needs-human', 'agents:auto-pilot-failed']
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `## ‚ö†Ô∏è Auto-Pilot Stopped

            **Reason:** Exceeded maximum cycle limit (${{ env.MAX_CYCLES }} cycles)

            This issue requires human review. Possible causes:
            - Repeated CI failures
            - Conflicting requirements
            - External dependencies

            **To resume:** Remove \`agents:auto-pilot-failed\` and \`needs-human\`
            labels, then re-add \`agents:auto-pilot\`.`
            });

            core.setFailed('Auto-pilot exceeded max cycles');

      - name: Determine next step
        if: |
          steps.context.outputs.should_continue == 'true' &&
          steps.cycles.outputs.exceeded != 'true'
        id: next
        env:
          FORCE_STEP: ${{ inputs.force_step }}
        run: |
          # Priority order of steps
          # 1. If issue closed and has verify label ‚Üí done
          # 2. If issue closed without verify ‚Üí add verify
          # 3. If no PR ‚Üí need agent assignment
          # 4. If has PR ‚Üí check PR state
          # 5. If no format ‚Üí format first
          # 6. If no optimize ‚Üí optimize
          # 7. If no apply ‚Üí apply suggestions

          ISSUE_STATE="${{ steps.context.outputs.issue_state }}"
          HAS_FORMAT="${{ steps.context.outputs.has_format }}"
          HAS_OPTIMIZE="${{ steps.context.outputs.has_optimize }}"
          HAS_APPLY="${{ steps.context.outputs.has_apply }}"
          HAS_AGENT="${{ steps.context.outputs.has_agent }}"
          LINKED_PR="${{ steps.context.outputs.linked_pr }}"
          HAS_VERIFY="${{ steps.context.outputs.has_verify }}"

          # Force step if specified (not 'auto')
          if [[ -n "$FORCE_STEP" && "$FORCE_STEP" != "auto" ]]; then
            echo "next_step=$FORCE_STEP" >> "$GITHUB_OUTPUT"
            echo "Forced step: $FORCE_STEP"
            exit 0
          fi

          # Issue closed = done or verify
          if [[ "$ISSUE_STATE" == "closed" ]]; then
            if [[ "$HAS_VERIFY" == "true" ]]; then
              echo "next_step=done" >> "$GITHUB_OUTPUT"
              echo "Issue closed with verification - auto-pilot complete"
            else
              echo "next_step=verify" >> "$GITHUB_OUTPUT"
              echo "Issue closed - triggering verification"
            fi
            exit 0
          fi

          # No PR yet - need to go through issue prep pipeline
          if [[ -z "$LINKED_PR" ]]; then
            if [[ "$HAS_AGENT" == "true" ]]; then
              echo "next_step=create-pr" >> "$GITHUB_OUTPUT"
              echo "Agent assigned, checking for branch to create PR"
            elif [[ "$HAS_FORMAT" != "true" ]]; then
              echo "next_step=format" >> "$GITHUB_OUTPUT"
              echo "Step 1: Format issue"
            elif [[ "$HAS_OPTIMIZE" != "true" ]]; then
              echo "next_step=optimize" >> "$GITHUB_OUTPUT"
              echo "Step 2: Optimize issue"
            elif [[ "$HAS_APPLY" != "true" ]]; then
              echo "next_step=apply" >> "$GITHUB_OUTPUT"
              echo "Step 3: Apply suggestions"
            else
              echo "next_step=capability-check" >> "$GITHUB_OUTPUT"
              echo "Step 4: Run capability check before agent"
            fi
            exit 0
          fi

          # Has PR - let keepalive/autofix handle it
          echo "next_step=monitor-pr" >> "$GITHUB_OUTPUT"
          echo "PR #$LINKED_PR exists - monitoring via keepalive"

      - name: Execute step - Format
        if: steps.next.outputs.next_step == 'format'
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ steps.context.outputs.issue_number }}
          STEP_COUNT: ${{ steps.cycles.outputs.count }}
        with:
          script: |
            const issueNumber = parseInt(process.env.ISSUE_NUMBER);
            const stepCount = parseInt(process.env.STEP_COUNT || '0') + 1;

            // Add progress comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `ü§ñ **Auto-pilot step ${stepCount}**: Starting issue formatting...

            Adding \`agents:format\` label to trigger LangChain formatting.`
            });

            // Add format label to trigger the formatter
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['agents:format']
            });

      - name: Execute step - Optimize
        if: steps.next.outputs.next_step == 'optimize'
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ steps.context.outputs.issue_number }}
          STEP_COUNT: ${{ steps.cycles.outputs.count }}
        with:
          script: |
            const issueNumber = parseInt(process.env.ISSUE_NUMBER);
            const stepCount = parseInt(process.env.STEP_COUNT || '0') + 1;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `ü§ñ **Auto-pilot step ${stepCount}**: Analyzing issue for improvements...

            Adding \`agents:optimize\` label to trigger analysis.`
            });

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['agents:optimize']
            });

      - name: Execute step - Apply suggestions
        if: steps.next.outputs.next_step == 'apply'
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ steps.context.outputs.issue_number }}
          STEP_COUNT: ${{ steps.cycles.outputs.count }}
        with:
          script: |
            const issueNumber = parseInt(process.env.ISSUE_NUMBER);
            const stepCount = parseInt(process.env.STEP_COUNT || '0') + 1;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `ü§ñ **Auto-pilot step ${stepCount}**: Applying optimization suggestions...

            Adding \`agents:apply-suggestions\` label.`
            });

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['agents:apply-suggestions']
            });

      - name: Execute step - Capability check & Agent
        if: steps.next.outputs.next_step == 'capability-check'
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ steps.context.outputs.issue_number }}
          STEP_COUNT: ${{ steps.cycles.outputs.count }}
        with:
          script: |
            const issueNumber = parseInt(process.env.ISSUE_NUMBER);
            const stepCount = parseInt(process.env.STEP_COUNT || '0') + 1;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `ü§ñ **Auto-pilot step ${stepCount}**: Issue prepared! Assigning to agent...

            Adding \`agent:codex\` label. The capability check will run automatically.

            ‚è≥ Agent will create a PR shortly.`
            });

            // Add agent label - capability check triggers on this
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['agent:codex']
            });

      - name: Execute step - Verify
        if: steps.next.outputs.next_step == 'verify'
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ steps.context.outputs.issue_number }}
        with:
          script: |
            const issueNumber = parseInt(process.env.ISSUE_NUMBER);

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `ü§ñ **Auto-pilot**: Issue closed. Triggering verification...

            Adding \`verify:evaluate\` label.`
            });

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['verify:evaluate']
            });

      - name: Execute step - Create PR
        if: steps.next.outputs.next_step == 'create-pr'
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ steps.context.outputs.issue_number }}
          ISSUE_TITLE: ${{ steps.context.outputs.issue_title }}
          STEP_COUNT: ${{ steps.cycles.outputs.count }}
        with:
          script: |
            const issueNumber = parseInt(process.env.ISSUE_NUMBER);
            const issueTitle = process.env.ISSUE_TITLE || `Issue #${issueNumber}`;
            const stepCount = parseInt(process.env.STEP_COUNT || '0') + 1;
            const branchName = `codex/issue-${issueNumber}`;

            // Check if branch exists
            let branchExists = false;
            try {
              await github.rest.repos.getBranch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                branch: branchName
              });
              branchExists = true;
              core.info(`Branch ${branchName} exists`);
            } catch (e) {
              if (e.status === 404) {
                core.info(`Branch ${branchName} does not exist yet`);
              } else {
                throw e;
              }
            }

            if (!branchExists) {
              // Branch not created yet - agent still working
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `ü§ñ **Auto-pilot step ${stepCount}**: Waiting for agent to create branch...

            The agent has been assigned but hasn't created the branch yet.
            Branch expected: \`${branchName}\`

            ‚è≥ Auto-pilot will check again on next trigger.`
              });
              return;
            }

            // Branch exists - create PR
            core.info(`Creating PR from ${branchName}`);

            const prTitle = `[Auto-pilot] ${issueTitle}`;
            const prBody = `<!-- meta:issue:${issueNumber} -->

            ## Auto-pilot PR

            This PR was automatically created by the auto-pilot workflow.

            Closes #${issueNumber}

            ---
            *Created by \`agents:auto-pilot\` workflow*`;

            try {
              const { data: pr } = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: prTitle,
                head: branchName,
                base: 'main',
                body: prBody
              });

              core.info(`Created PR #${pr.number}`);

              // Add standard agent labels to the PR (separate try-catch to not fail PR creation)
              let labelsAdded = false;
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  labels: ['agent:codex', 'agents:keepalive', 'autofix']
                });
                labelsAdded = true;
                core.info(`Added agent labels to PR #${pr.number}`);
              } catch (labelError) {
                core.warning(
                  `Failed to add labels to PR #${pr.number}: ${
                    labelError && labelError.message ? labelError.message : labelError
                  }`
                );
              }

              const labelStatus = labelsAdded
                ? '‚úÖ Added labels: `agent:codex`, `agents:keepalive`, `autofix`'
                : '‚ö†Ô∏è Could not add labels (add manually)';

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `ü§ñ **Auto-pilot step ${stepCount}**: PR created!

            ‚úÖ Created PR #${pr.number} from branch \`${branchName}\`
            ${labelStatus}

            The PR will now go through CI checks. Auto-pilot will continue monitoring.`
              });

            } catch (e) {
              if (e.status === 422 && e.message?.includes('already exists')) {
                core.info('PR already exists - this is fine');
              } else {
                // PR creation failed - report but don't fail workflow
                core.warning(`Failed to create PR: ${e.message}`);
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: `ü§ñ **Auto-pilot step ${stepCount}**: Could not create PR

            ‚ö†Ô∏è Branch \`${branchName}\` exists but PR creation failed.

            Error: ${e.message}

            Please create the PR manually or check permissions.`
                });
              }
            }

      - name: Report - Monitoring PR
        if: steps.next.outputs.next_step == 'monitor-pr'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = '${{ steps.context.outputs.linked_pr }}';
            core.info(`PR #${prNumber} exists. Keepalive and autofix will handle CI.`);

      - name: Report - Done
        if: steps.next.outputs.next_step == 'done'
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ steps.context.outputs.issue_number }}
        with:
          script: |
            const issueNumber = parseInt(process.env.ISSUE_NUMBER);

            // Remove auto-pilot label since we're done
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                name: 'agents:auto-pilot'
              });
            } catch (e) {
              // Label might already be removed (404) - that's OK
              if (e && e.status === 404) {
                core.info('Auto-pilot label already removed or not found');
              } else {
                core.warning(`Unexpected error removing auto-pilot label: ${e?.message || e}`);
              }
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `## ‚úÖ Auto-Pilot Complete

            This issue has been fully processed:
            - ‚úÖ Issue formatted and optimized
            - ‚úÖ Agent assigned and PR created
            - ‚úÖ PR merged
            - ‚úÖ Verification triggered

            Thank you for using auto-pilot! üöÄ`
            });

            core.info('Auto-pilot complete!');
