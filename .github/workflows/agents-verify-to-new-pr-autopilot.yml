name: Verify-to-New-PR Auto-Pilot Continuation

on:
  workflow_run:
    workflows: ["Create New PR from Verification"]
    types: [completed]

permissions:
  contents: read
  issues: write
  pull-requests: write
  actions: write

jobs:
  continue-auto-pilot:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Select GitHub token
        id: select-token
        env:
          CODESPACES_WORKFLOWS: ${{ secrets.CODESPACES_WORKFLOWS }}
          OWNER_PR_PAT: ${{ secrets.OWNER_PR_PAT }}
          SERVICE_BOT_PAT: ${{ secrets.SERVICE_BOT_PAT }}
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          if [ -n "$CODESPACES_WORKFLOWS" ]; then
            echo "token=$CODESPACES_WORKFLOWS" >> "$GITHUB_OUTPUT"
          elif [ -n "$OWNER_PR_PAT" ]; then
            echo "token=$OWNER_PR_PAT" >> "$GITHUB_OUTPUT"
          elif [ -n "$SERVICE_BOT_PAT" ]; then
            echo "token=$SERVICE_BOT_PAT" >> "$GITHUB_OUTPUT"
          else
            echo "token=$GITHUB_TOKEN" >> "$GITHUB_OUTPUT"
          fi

      - name: Download follow-up issue metadata
        uses: actions/download-artifact@v7
        with:
          name: verify-create-new-pr-output
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ steps.select-token.outputs.token }}

      - name: Read issue number from artifact
        id: read-meta
        run: |
          set -euo pipefail
          num=$(jq -r '.issue_number' followup_issue_output.json)
          if [ -z "${num}" ] || [ "${num}" = "null" ]; then
            echo "Missing issue_number" >&2
            exit 1
          fi
          echo "issue_number=${num}" >> "$GITHUB_OUTPUT"

      - name: Checkout Workflows repo
        uses: actions/checkout@v6
        with:
          repository: stranske/Workflows
          token: ${{ steps.select-token.outputs.token }}
          sparse-checkout: |
            .github/actions/setup-api-client
            .github/scripts/github-api-with-retry.js
            .github/scripts/token_load_balancer.js

      - name: Setup API client
        uses: ./.github/actions/setup-api-client
        with:
          secrets: ${{ toJSON(secrets) }}
          github_token: ${{ github.token }}

      - name: Dispatch auto-pilot from optimize step
        uses: actions/github-script@v8
        env:
          ISSUE_NUMBER: ${{ steps.read-meta.outputs.issue_number }}
          DEFAULT_BRANCH: >-
            ${{ github.event.repository.default_branch }}
        with:
          github-token: ${{ steps.select-token.outputs.token }}
          script: |
            const fs = require('fs');
            const retryPath =
              './.github/scripts/github-api-with-retry.js';
            const retryHelpers = fs.existsSync(retryPath)
              ? require(retryPath)
              : { withRetry: (fn) => fn() };
            const { withRetry } = retryHelpers;
            await withRetry((client) =>
              (client || github).rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'agents-auto-pilot.yml',
                ref: process.env.DEFAULT_BRANCH,
                inputs: {
                  issue_number: process.env.ISSUE_NUMBER,
                  force_step: 'optimize'
                }
              })
            );
